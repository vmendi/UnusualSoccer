<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 width="100%" height="100%" addedToStage="AddedToStageHandler(event)"
		 creationComplete="CreationCompleteHandler(event)">
	
	<fx:Script>
		<![CDATA[
			import GameModel.LoginModel;
			import GameModel.MainGameModel;
			import GameModel.PredefinedTeamsModel;
			
			import HttpService.enum.VALID_NAME;
			
			import mx.binding.utils.BindingUtils;
			import mx.events.FlexEvent;
			
			import spark.events.IndexChangeEvent;
			import spark.events.TextOperationEvent;
			
			protected function CreationCompleteHandler(event:FlexEvent):void
			{
				mMainGameModel = SoccerClient.GetMainGameModel();
				mLoginModel = mMainGameModel.TheLoginModel; 
				mPredefinedTeamsModel = mMainGameModel.ThePredefinedTeamsModel;
				
				mAgeValidity = !AppConfig.IsMahouLigaChapas;
				
				MyPredefinedTeamList.addEventListener(IndexChangeEvent.CHANGE, OnMyPredefinedTeamListSelectionChanged);
				
				// Get the country from the server, pre-select the country in our list
				var countryID : String = mPredefinedTeamsModel.TranslateCountryISOCodeToCountryID(AppConfig.COUNTRY);
				MyPredefinedTeamList.selectedIndex = mPredefinedTeamsModel.PredefinedTeamNameIDs.getItemIndex(countryID);

				BindingUtils.bindSetter(OnIsValidTeamNameLastResult, mLoginModel, ["IsValidTeamNameLastResult"]);
			}

			protected function AddedToStageHandler(event:Event):void
			{
				GameMetrics.ReportEvent(GameMetrics.LOGIN_SCREEN, null);
				GameMetrics.ReportPageView(GameMetrics.VIEW_LOGIN);
			}
			
			protected function OnMyPredefinedTeamListSelectionChanged(e:IndexChangeEvent):void
			{
				OnIsValidTeamNameLastResult(mLoginModel.IsValidTeamNameLastResult);
			}
			
			private function OnIsValidTeamNameLastResult(validity : String) : void
			{				
				if (MyPredefinedTeamList.selectedIndex != -1)
				{
					if (validity == VALID_NAME.VALID)
						SetNameValidity(true, resourceManager.getString('main','LoginNameAvailable'));
					else if (validity == VALID_NAME.GUEST)
						SetNameValidity(true, resourceManager.getString('main','LoginNameIsGuest'));
					else if (validity == VALID_NAME.EMPTY)
						SetNameValidity(false, resourceManager.getString('main','LoginEnterName'));	
					else if (validity == VALID_NAME.DUPLICATED)
						SetNameValidity(false, resourceManager.getString('main','LoginNotAvailable'));	
					else if (validity == VALID_NAME.INAPPROPIATE)
						SetNameValidity(false, resourceManager.getString('main','LoginInappropriateName'));
					else if (validity == VALID_NAME.TOO_SHORT)
						SetNameValidity(false, resourceManager.getString('main','LoginNameTooShort'));
					else if (validity == VALID_NAME.WHITE_SPACE_TRIM)
						SetNameValidity(false, resourceManager.getString('main','LoginNameBlank'));
					else if (validity == VALID_NAME.TOO_MANY_WHITESPACES)
						SetNameValidity(false, resourceManager.getString('main','LoginNameBlankSpaces'));
					else
						SetNameValidity(false, resourceManager.getString('main','LoginInvalidName'));
				}
				else
				{
					SetNameValidity(false, resourceManager.getString('main','LoginSelectNation'));
				}
			}
			
			private function SetNameValidity(valid : Boolean, text : String) : void
			{
				MyValidityLabel.text = text;
				mNameValidity = valid;
				
				if (valid)
					MyValidityLabel.setStyle("color", "#0DBF00");
				else
					MyValidityLabel.setStyle("color", "#E26261");
			}
						
			protected function MyRadioButtonYes_changeHandler(event:Event):void
			{
				mAgeValidity = true;
			}
			
			protected function MyRadioButtonNo_changeHandler(event:Event):void
			{
				mAgeValidity = false;
			}
			
			protected function MyTeamNameInput_changeHandler(event:TextOperationEvent):void
			{				
				mLoginModel.IsValidTeamName(MyTeamNameInput.text);
			}
			
			protected function MyButtonNext_clickHandler(event:MouseEvent):void
			{
				mWaitingForTeamCreation = true;
				
				mMainGameModel.TheTeamModel.CreateTeam(MyTeamNameInput.text != ""? MyTeamNameInput.text : LoginModel.GUEST_NAME, 
													   MyPredefinedTeamList.selectedItem, 
												   	   OnTeamCreatedResponse, OnTeamCreationFailed);
			}
			
			private function OnTeamCreationFailed() : void
			{
				mWaitingForTeamCreation = false;
			}
			
			private function OnTeamCreatedResponse():void
			{
				GameMetrics.ReportEvent(GameMetrics.TEAM_SELECTED, {predefinedTeamID: MyPredefinedTeamList.selectedItem});
				GameMetrics.Set(GameMetrics.PEOPLE_TEAM, MyPredefinedTeamList.selectedItem);
				
				(HierarchyUtils.FindParentOfType(this, getQualifiedClassName(MainView)) as MainView).StartFirstGameAfterLogin();
			}
			
			[Bindable] private var mMainGameModel : MainGameModel;
			[Bindable] private var mLoginModel : LoginModel;
			[Bindable] private var mPredefinedTeamsModel : PredefinedTeamsModel;
			
			[Bindable] private var mNameValidity : Boolean = false;
			[Bindable] private var mAgeValidity : Boolean = false;
			[Bindable] private var mWaitingForTeamCreation : Boolean = false;
		]]>
	</fx:Script>
	
	<fx:Style source="styles.css"/>
	
	<fx:Style>
		@namespace s "library://ns.adobe.com/flex/spark";
		
		.headerBox {
			font-family:MyFontHelveticaNeueLTBold;
			font-size:15pt;
			font-weight:bold;
			color:#FFFFFF;
		}
	</fx:Style>
	
	<fx:Declarations>
		<s:DropShadowFilter id="MyTextDropShadowFilter" angle="270" blurX="1" blurY="1"
							color="0x444444" distance="1"/>
	</fx:Declarations>	
	
	<s:BitmapImage fillMode="clip" source="{resourceManager.getClass('main','LoginBg')}"/>
	
	<s:SWFLoader x="0" y="0" source="{resourceManager.getString('main','LoginLogoSource')}"/>
	
	<s:Panel x="10" y="40" width="700" skinClass="GameView.Skins.DefaultPanelSkin"
			 title="{resourceManager.getString('main','Login01SelectTeam')}">
		<s:layout>
			<s:VerticalLayout gap="0"/>
		</s:layout>
		<s:List id="MyPredefinedTeamList" left="0" top="0" width="700" height="320" tabEnabled="false" tabFocusEnabled="false"
				dataProvider="{mPredefinedTeamsModel.PredefinedTeamNameIDs}"
				itemRenderer="GameView.PredefinedTeamItem" skinClass="GameView.Skins.DefaultListSkin">
			<s:layout>
				<s:TileLayout />
			</s:layout>
		</s:List>
		
		<s:Group>
			<s:layout>
				<s:VerticalLayout gap="6" horizontalAlign="center"/>
			</s:layout>
			<s:Group>
				<s:Rect id="tbFill" x="0" y="0" width="100%" height="27">
					<s:fill>
						<s:LinearGradient rotation="90">
							<s:GradientEntry alpha="1" color="#fe0001" ratio="0"/>
							<s:GradientEntry alpha="1" color="#8c1304" ratio="1.0"/>
						</s:LinearGradient>
					</s:fill>
				</s:Rect>
				<s:Label id="myStep2Label" x="10" y="0" width="350" height="27"
						 filters="{MyTextDropShadowFilter}" maxDisplayedLines="1"
						 styleName="headerBox"
						 text="{resourceManager.getString('main','Login02EnterName')}"
						 textAlign="start" verticalAlign="middle"></s:Label>
			</s:Group>
			
			<s:Label id="myStep2Txt" x="10" y="35" width="350" styleName="whiteBoldBig"
					 text="{resourceManager.getString('main','Login02EnterNameTxt')}"
					 textAlign="center" verticalAlign="middle"></s:Label>
			
			<s:TextInput id="MyTeamNameInput" x="82" y="97" width="200"
						 change="MyTeamNameInput_changeHandler(event)" maxChars="30"
						 styleName="blackBoldMediumHN" prompt="{LoginModel.GUEST_NAME}"/>
			
			<s:Label id="MyValidityLabel" x="32" y="126" width="300" height="40" color="#0DBF00"
					 styleName="whiteBoldBig" textAlign="center"/>
		</s:Group>
		
		<s:Group visible="{AppConfig.IsMahouLigaChapas}" x="0"
				 includeInLayout="{AppConfig.IsMahouLigaChapas}">
			<s:Rect id="tbFill2" x="0" y="0" width="100%" height="27">
				<s:fill>
					<s:LinearGradient rotation="90">
						<s:GradientEntry alpha="1" color="#fe0001" ratio="0"/>
						<s:GradientEntry alpha="1" color="#8c1304" ratio="1.0"/>
					</s:LinearGradient>
				</s:fill>
			</s:Rect>
			<s:Label id="myStep3Label" x="10" y="0" width="350" height="27"
					 filters="{MyTextDropShadowFilter}" maxDisplayedLines="1" styleName="headerBox"
					 text="3. ACEPTA LAS CONDICIONES LEGALES" textAlign="start"
					 verticalAlign="middle"></s:Label>
			
			<s:Label id="myStep3Txt" x="10" y="32" width="350" styleName="whiteBoldBig"
					 text="Para jugar a este juego debes ser mayor de edad." textAlign="center"
					 verticalAlign="middle"></s:Label>
			
			<s:Label id="myStep4Txt" x="100" y="56" styleName="whiteBoldBig" text="¿Lo eres?"
					 textAlign="center" verticalAlign="middle"></s:Label>
			
			<s:RadioButton id="myRadioButtonYes" x="170" y="52" label="Sí"
						   change="MyRadioButtonYes_changeHandler(event)" groupName="SoyMayorEdad"
						   styleName="whiteBoldBig"/>
			<s:RadioButton id="myRadioButtonNo" x="210" y="52" label="No"
						   change="MyRadioButtonNo_changeHandler(event)" groupName="SoyMayorEdad"
						   styleName="whiteBoldBig"/>
		</s:Group>
		
		<s:Group>
			<s:BitmapImage fillMode="clip"
						   source="@Embed(source='/Assets/General.swf', symbol='LoginBottomBg')"/>
			<s:Button id="MyButtonNext" x="98" top="4" width="160" height="24"
					  label="{resourceManager.getString('main','Continue')}"
					  click="MyButtonNext_clickHandler(event)" enabled="{mAgeValidity &amp;&amp; mNameValidity}"
					  skinClass="GameView.Skins.ButtonGreySkin"/>
		</s:Group>
		
	</s:Panel>

</s:Group>


