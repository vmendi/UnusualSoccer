<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009"
			   xmlns:s="library://ns.adobe.com/flex/spark"
			   xmlns:local="*"
			   width="760" height="650" applicationComplete="ApplicationCompleteHandler(event)"
			   frameRate="30" preloader="ProgressPreloader">
	
	<fx:Metadata>
		[ResourceBundle("main")]
	</fx:Metadata>
	

	<fx:Script><![CDATA[
		import GameModel.MainGameModel;
		
		import GameView.MainView;
		
		import SoccerServer.DataTypeInitializer;
		
		import mx.events.FlexEvent;

		protected function ApplicationCompleteHandler(event:FlexEvent):void
		{
			//FPSCounter.Init(this.stage, new Point(0,0));
			
			// Excepciones globales capturadas
			if (loaderInfo.hasOwnProperty("uncaughtErrorEvents"))
				IEventDispatcher(loaderInfo["uncaughtErrorEvents"]).addEventListener("uncaughtError", ErrorMessages.UncaughtErrorHandler);
			
			// Si se dispara esta señal, la dispare quien la dispare, nos quedamos en blanco
			ErrorMessages.OnCleaningShutdownSignal.addOnce(RemoveMainView);
			
			// Carga de parametros y configuracion global
			AppConfig.Init(parameters);
			
			// Para que las estructuras creadas por weborb existan
			var dataTypeInit : DataTypeInitializer = new DataTypeInitializer();

			if (AppConfig.TEST != null)
			{
				mFacebookFacade = new FacebookFacade();
				mMainGameModel = new MainGameModel();
				
				MyServerTests.visible = true;
				MyServerTests.ExecuteTest(AppConfig.TEST);
			}
			else
			{
				mFacebookFacade = new FacebookFacade();
				mFacebookFacade.Init(OnFacebookInitSuccess);
			}
		}
		
		private function OnFacebookInitSuccess():void
		{
			mMainGameModel = new MainGameModel();
			mMainGameModel.InitialRefresh(OnInitialRefreshSuccess);
			
			function OnInitialRefreshSuccess() : void
			{
				mMainView = new MainView();
				addElement(mMainView);
			}
		}

		private function OnCleaningShutdown() : void
		{
			RemoveMainView();
			
			if (mMainGameModel != null)
			{
				mMainGameModel.OnCleaningShutdown();
				mMainGameModel = null;
			}
		}
		
		private function RemoveMainView() : void
		{
			if (mMainView != null)
				removeElement(mMainView);
			mMainView = null;
		}
		
		private var mMainView : MainView;
		
		/// En vez de andar pasándolo por ahí en Inits, singletonizamos
		static private var mMainGameModel : MainGameModel;
		static public function GetMainGameModel() : MainGameModel {	return mMainGameModel; }
		
		// Idem
		static private var mFacebookFacade : FacebookFacade;
		static public function GetFacebookFacade() : FacebookFacade { return mFacebookFacade; }
	
	]]></fx:Script>
	
	<local:ServerTests id="MyServerTests" visible="false" width="100%" height="100%"/>
			
</s:Application>
